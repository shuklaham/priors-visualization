<!DOCTYPE html>
<meta charset="utf-8">
<style>

/*.patienthistory {
          display: inline-block;
          width: 20px;
          height: 75px;   /* Gets overriden by D3-assigned height below */
          /*margin-right: 2px;
          background-color: teal;*/
.fontxaxis text {
  font-family: sans-serif;
  font-size: 12px;
}

.fontyaxis text {
  font-family: sans-serif;
  font-size: 12px;
}

.fontxaxis path,
.fontxaxis line {
  fill: none;
  stroke: black;
  shape-rendering: crispEdges;
}
.fontyaxis path,
.fontyaxis line {
  fill: none;
  stroke: black;
  shape-rendering: crispEdges;
}

            #tooltip {
                position: absolute;
                width: 200px;
                height: auto;
                padding: 10px;
                background-color: white;
                -webkit-border-radius: 10px;
                -moz-border-radius: 10px;
                border-radius: 10px;
                -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
                -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
                box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
                pointer-events: none;
            }

            #tooltip.hidden {
                display: none;
            }
            #tooltip p {
                margin: 0;
                font-family: sans-serif;
                font-size: 12px;
                line-height: 20px;
            }
            .repdata:hover {
                /*fill: #d3d3d3;*/
                fill: #7e7e7e;
            }

</style>
<body>
          <div id="tooltip" class="hidden">
            <p><span id="value">100</span></p>
        </div>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script>


var datesreps = ["Nov-01-2015","Sep-01-2015","July-01-2015"];
//var datesreps = ["July-01-2015","Sep-01-2015","Nov-01-2015"]
var newdates = [];

var colorArray = {};
colorArray[-1] = "#000000"
colorArray[1] = "#FF8C00"

var legendArray = ["Absence", "Presence"]

for (var d in datesreps){
  var months;
  d1 = new Date(datesreps[d]);
  d2 = new Date();
  months = (d2.getFullYear() - d1.getFullYear()) * 12;
  months -= d1.getMonth() + 1;
  months += d2.getMonth();
  months = months <= 0 ? 0 : months;
  if(months < 1){
              newdates.push(datesreps[d] + ' ' + " <-one-month");
          }
          else{
              newdates.push(datesreps[d] + ' ' + months + "-months-old");
          }
  }

newdates.splice(0, 0, " ");
newdates.push("   ");

var findings = ["    ",
                "Hepatic Lesions",
                "Lymphadenopathy",
                "Adrenal Nodules",
                "Retroperitoneal Edema",
                "Small Volume Ascites",
                "Soft Tissue Thickening",
                "Vertebral Body",
                "Metastasis",
                "Hepatic Metastases",
                "Adrenal Metastasis",
                "     "]

//margins and width
var margin = {top: 100  , right: 100, bottom: 100, left: 10},
    width = 700,// - margin.left - margin.right,
    height = 800, //- margin.top - margin.bottom;
    historywidth = 600,
    historyheight = 100

// create an svg container for text history of patient
/*var svgtext = d3.select("body").append("svg")
    //.attr("width", (width + margin.left + margin.right))
    //.attr("height", (height + margin.top + margin.bottom))
    .attr("width", (historywidth))
    .attr("height", (historyheight))
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + 10 + ")");

svgtext.append("rect")
    .attr("width", "100%")
    .attr("height", "100%")
    .attr("fill", "teal");
*/
// create an svg container for chart

var svgchart = d3.select("body").append("svg")
    //.attr("width", (width + margin.left + margin.right))
    //.attr("height", (height + margin.top + margin.bottom))
    .attr("width", (width))
    .attr("height", (height))
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

//placing a rectangle around text

svgchart.append("rect")
  .attr("class", "patienthistory")
  .attr("width", 480)
  .attr("height", 48)
  .style("stroke", "black")    // set the line colour
  .style("fill", "black")
  .style("stroke-width","0.5")
  .attr("transform", "translate(" + 180+ "," + -95 + ")");


//patient history text
history = ['CLINICAL STATEMENT: Metastatic gastric cancer', 
            'TECHNIQUE: CT of the chest, abdomen and pelvis with intravenous contrast'
          ]

svgchart.append("text")
      .attr("class", "title")
      .attr("x", 185)
      .attr("y", -80)
      .text("CLINICAL STATEMENT: Metastatic gastric cancer")
      .attr("font-family", "Helvetica Neue")
      .attr("font-size", "14px")
      .attr("font-weight","bold")
      .attr("fill", "white");

svgchart.append("text")
      .attr("class", "title")
      .attr("x", 185)
      .attr("y", -60)
      .text("TECHNIQUE: CT of the chest, abdomen and pelvis with intravenous contrast")
      .attr("font-family", "Helvetica Neue")
      .attr("font-size", "14px")
      .attr("font-weight","bold")
      .attr("fill", "white");

svgchart.append("text")
      .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
      .attr("transform", "translate("+ 30 +","+230+")rotate(-90)")  // text is drawn off the screen top left, move down and out and rotate
      .text("FINDINGS")
      .attr("font-family", "Helvetica Neue")
      .attr("font-size", "16px")
      .attr("font-weight","bold")
      .attr("fill", "black");

// Legend
/*svgchart.selectAll("rect.legend")
               .data([1,2])
               .enter()
               .append("rect")
               .attr("class", "legend") 
               .attr("x", function(d, i) {
                    return 50 + 200*(i)
               })
               .attr("y", function(d, i) {
                    return 520;
               })
               .attr("width", 108)
               .attr("height", 45);
 */
//legend      
var svg = d3.select("body").select("svg");


svg.selectAll("rect.legend")
               .data([-1,1])
               .enter()
               .append("rect")
               .attr("class", "legend") 
               .attr("x", function(d, i) {
                    return 340 + i*99
               })
               .attr("y", function(d, i) {
                    return 640
               })
               .attr("width", 98)
               .attr("height", 44)
               .attr("fill", function(d,i) {
                    return colorArray[d]});

svg.selectAll("text.legendText")
               .data(legendArray)
               .enter()
               .append("text")
               .attr("class","legendText")
               .text(function(d){
                    return d;
               })
               .attr("text-anchor", "left")
               .attr("x", function(d, i){
                    return 360 + i*99})
               .attr("y", function(d, i) {
                    return 638;
                })
               .attr("font-family", "Helvetica Neue")
               .attr("font-size", "14px")
               .attr("font-weight","bold")
               .attr("fill", "black");

            svg.append("text")
               .attr("class","legendName")
               .text(function(d){
                    return 'Legend';
               })
               .attr("text-anchor", "left")
               .attr("x", 280)
               .attr("y", 665)
               .attr("font-family", "Helvetica Neue")
               .attr("font-size", "14px")
               .attr("font-weight","bold")
               .attr("fill", "black");

/*.append("rect")
  .attr("class", "patienthistory")
  .attr("width", 480)
  .attr("height", 48)
  .style("stroke", "black")    // set the line colour
  .style("fill", "none")
  .style("stroke-width","0.5")
  .attr("transform", "translate(" + 1+ "," + 95 + ")");
*/
// draw the x axis
// define the x and y scale
var xRange = d3.scale.ordinal()
    .domain(newdates)
    .rangePoints([0, width-300]);

var yRange = d3.scale.ordinal()
    .domain(findings)
    .rangePoints([0, height-300]);

// define the x axis
var xAxis = d3.svg.axis()
    .scale(xRange)
    .orient("top");

// define the y axis
var yAxis = d3.svg.axis()
    .scale(yRange)
    .orient("left");

// draw the x axis
svgchart.append("g")
    .attr("class", "fontxaxis")
    .attr("transform", "translate(" + 180 + ",0)")
    .call(xAxis)
  .selectAll(".tick text")
    .call(wrap, xRange.rangeBand())
    .attr("transform", "translate("+0+",-30)");



function wrap(text, width) {
  text.each(function() {
    var text = d3.select(this),
        words = text.text().split(/\s+/).reverse(),
        word,
        line = [],
        lineNumber = 0,
        lineHeight = 1.1, // ems
        y = text.attr("y"),
        dy = parseFloat(text.attr("dy")),
        tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em");
    while (word = words.pop()) {
      line.push(word);
      tspan.text(line.join(" "));
      if (tspan.node().getComputedTextLength() > width) {
        line.pop();
        tspan.text(line.join(" "));
        line = [word];
        tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
      }
    }
  });
}

// draw the y axis
svgchart.append("g")
    .attr("class", "fontyaxis")
    .attr("transform", "translate(" + 180 + ",0)")
    .call(yAxis);


var repdata = [{
  "x": "Nov-01-2015 2-months-old",
  "y": "Lymphadenopathy",
  "z":1,
  "s":"Progression of disease with increase in lymphadenopathy and bilateral adrenal nodules"
}, {
  "x": "Nov-01-2015 2-months-old",
  "y": "Adrenal Nodules",
  "z":1,
  "s":"Progression of disease with increase in lymphadenopathy and bilateral adrenal nodules"
}, {
  "x": "Nov-01-2015 2-months-old",
  "y": "Retroperitoneal Edema",
  "z":1,
  "s":"Increased mesenteric/retroperitoneal edema"
}, {
  "x": "Nov-01-2015 2-months-old",
  "y": "Small Volume Ascites",
  "z":1,
  "s":"New small-volume ascites"
}, {
  "x": "Nov-01-2015 2-months-old",
  "y": "Soft Tissue Thickening",
  "z":1,
  "s": "Soft tissue thickening along the undersurface of the left diaphragm is stable from the recent exam but increased from older studies and suspicious for peritoneal tumor"
}, {
  "x": "Nov-01-2015 2-months-old",
  "y": "Vertebral Body",
  "z":1,
  "s":"Increase in subtle sclerosis in the superior half of the L2 vertebral body suspicious for metastasis"
}, {
  "x": "Nov-01-2015 2-months-old",
  "y": "Metastasis",
  "z":1,
  "s":"Increase in subtle sclerosis in the superior half of the L2 vertebral body suspicious for metastasis"
},{
  "x": "Sep-01-2015 4-months-old",
  "y": "Hepatic Lesions",
  "z":-1,
  "s":"No new hepatic lesions identified"
}, {
  "x": "Sep-01-2015 4-months-old",
  "y": "Lymphadenopathy",
  "z":1,
  "s":"Stable mild abdominopelvic lymphadenopathy"
}, {
  "x": "Sep-01-2015 4-months-old",
  "y": "Hepatic Metastases",
  "z":1,
  "s":"No new hepatic lesions identified"
}, {
  "x": "Sep-01-2015 4-months-old",
  "y": "Adrenal Metastasis",
  "z":1,
  "s":"Stable right adrenal metastatic lesion"
},{
  "x": "July-01-2015 6-months-old",
  "y": "Hepatic Lesions",
  "z":-1,
  "s":"No new suspicious hepatic lesions"
},{
  "x": "July-01-2015 6-months-old",
  "y": "Lymphadenopathy",
  "z":1,
  "s":"Mild abdominopelvic lymphadenopathy, with nodes stable or slightly decreased in size"
},{
  "x": "July-01-2015 6-months-old",
  "y": "Hepatic Metastases",
  "z":1,
  "s":"Stable hepatic metastasis"
},{
  "x": "July-01-2015 6-months-old",
  "y": "Adrenal Metastasis",
  "z":1,
  "s":"Mild interval decrease in size of bilateral adrenal metastases"
}
  ];


var rectw = 98,
n = rectw+30
var recth = 44

        svgchart.selectAll("rect")
               .data(repdata)
               .enter()
               .append("rect")
               .attr("class", "repdata")
               .attr("x", function(d, i) {
                    return xRange(d.x);
               })
               .attr("y", function(d, i) {
                    return yRange(d.y);
               })
               .attr("width", rectw)
               .attr("height", recth)
               .attr("transform", "translate(" + n+ "," + recth*(-1)/2 + ")")
               .attr("fill", function(d) {
                    return colorArray[d.z]})

               .on("mouseover", function(d) {

                //Get this bar's x/y values, then augment for the tooltip
                var xPosition = parseFloat(d3.select(this).attr("x")) + 200;
                var yPosition = parseFloat(d3.select(this).attr("y")) + 50;

                //Update the tooltip position and value
                d3.select("#tooltip")
                  .style("left", xPosition + "px")
                  .style("top", yPosition + "px")
                  .select("#value")
                  .text(d.s);

                //Show the tooltip
                d3.select("#tooltip").classed("hidden", false);

                })
               .on("mouseout", function() {

                //Hide the tooltip
                d3.select("#tooltip").classed("hidden", true);

               });
               

</script>
</body>
</html>